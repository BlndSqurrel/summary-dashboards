<!DOCTYPE html>
<html>
<head>
    <title>wip-limits-chart</title>

    <script type="text/javascript" src="https://10.32.16.145/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var release=null,iteration="Iteration 1",that=this,tbs=that.getTimeboxScope();_.isNull(tbs)||(release="release"===tbs.type?tbs.name:null,iteration="iteration"===tbs.type?tbs.name:null),that.run(release,iteration)},run:function(releaseName,iterationName){var that=this;that.workItemFilter=that.createFilter(releaseName,iterationName),console.log(""+that.workItemFilter);var fns=[that.readStates.bind(that),that.readProjects.bind(that),that.getReportProjects.bind(that),that.readWipValues.bind(that),that.readStories.bind(that),that.prepareChartData.bind(that),that.createChart.bind(that)];async.waterfall(fns,function(err,result){console.log("result",result)})},getTimeboxScope:function(){var timeboxScope=this.getContext().getTimeboxScope();return timeboxScope?{type:timeboxScope.getType(),name:timeboxScope.getRecord().get("Name")}:null},onTimeboxScopeChange:function(newTimeboxScope){this.callParent(arguments),newTimeboxScope&&"iteration"===newTimeboxScope.getType()?this.run(null,newTimeboxScope.getRecord().get("Name")):newTimeboxScope&&"release"===newTimeboxScope.getType()&&this.run(newTimeboxScope.getRecord().get("Name"),null)},readStates:function(callback){var that=this;Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records,operation,success){that.scheduleStates=_.map(records,function(r){return r.get("StringValue")}),callback(null)}})}})},readProjects:function(callback){var that=this,config={model:"Project",fetch:!0,filters:[]};that._wsapiQuery(config,callback)},getReportProjects:function(projects,callback){var that=this;that.projects=projects,that.reportProjects=_.filter(projects,function(project){return that._isChildOf(project,that.getContext().getProject())}),0===that.reportProjects.length&&that.reportProjects.push(_.find(that.projects,function(project){return project.get("ObjectID")===that.getContext().getProject().ObjectID})),callback(null)},readWipValues:function(callback){var that=this,projectKeys=_.map(that.reportProjects,function(p){return p.get("Name")}),states=["In-Progress","Completed"],keys=_.flatten(_.map(projectKeys,function(pKey){return _.map(states,function(state){return"project-wip:"+pKey+":"+state+"WIP"})}));console.log("keys",keys);var configs=_.map(keys,function(key){return{model:"Preference",filters:[{property:"Name",operator:"=",value:key}],fetch:!0}});async.map(configs,that._wsapiQuery,function(error,results){console.log("prefernece results",_.flatten(results)),that.wipLimits=_.flatten(results),callback(null)})},readStories:function(callback){var that=this,configs=_.map(that.reportProjects,function(project){return{model:"HierarchicalRequirement",filters:[that.workItemFilter],fetch:["ObjectID","ScheduleState","PlanEstimate","Project"],context:{project:project.get("_ref"),projectScopeUp:!1,projectScopeDown:!0}}});async.map(configs,that._wsapiQuery,function(error,results){console.log("stories",results),callback(null,results)})},prepareChartData:function(stories,callback){var that=this,categories=_.map(that.reportProjects,function(p){return p.get("Name")}),states=["In-Progress","Completed"],pointsValue=function(value){return _.isUndefined(value)||_.isNull(value)?0:value},summarize=function(workItems,states){var stateTotal=_.reduce(workItems,function(memo,workItem){return memo+(_.indexOf(states,workItem.get("ScheduleState"))>-1?1:0)},0);return stateTotal},wipForProjectAndState=function(project,state){var wip=_.find(that.wipLimits,function(limit){return-1!==limit.get("Name").indexOf(project.get("Name"))&&-1!==limit.get("Name").indexOf(state)});if(_.isUndefined(wip)||_.isNull(wip))return 0;var val=wip.get("Value").replace(/"/g,"");return parseInt(val)},seriesData=_.map(states,function(state){var counts=_.map(categories,function(project,index){return summarize(stories[index],[state])}),wips=_.map(categories,function(project,index){return wipForProjectAndState(that.reportProjects[index],state)});return console.log("counts",counts,"wips",wips),{name:state,data:_.map(categories,function(project,index){return counts[index]-wips[index]})}});console.log("seriesData",seriesData),callback(null,categories,seriesData)},createChart:function(categories,seriesData,callback){var that=this;_.isUndefined(that.chart)||that.remove(that.chart),that.chart=Ext.create("Rally.technicalservices.wipChart",{itemId:"rally-chart",chartData:{series:seriesData,categories:categories},title:"WIP Limits by Projecgt"}),that.add(that.chart);var chart=this.down("#rally-chart"),p=Ext.get(chart.id);elems=p.query("div.x-mask"),_.each(elems,function(e){e.remove()});var elems=p.query("div.x-mask-msg");_.each(elems,function(e){e.remove()})},createFilter:function(releaseName,iterationName){var filter=null;if(_.isNull(releaseName)||(filter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operator:"=",value:releaseName})),!_.isNull(iterationName)){var ifilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",operator:"=",value:iterationName});filter=_.isNull(filter)?ifilter:filter.and(ifilter)}return filter},_isChildOf:function(child,parent){var childParentRef=_.isNull(child.get("Parent"))?"null":child.get("Parent")._ref;return parent._ref.indexOf(childParentRef)>-1},_wsapiQuery:function(config,callback){var storeConfig={autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}};_.isUndefined(config.context)||(storeConfig.context=config.context),Ext.create("Rally.data.WsapiDataStore",storeConfig)}});
                Ext.define("Rally.technicalservices.wipChart",{extend:"Rally.ui.chart.Chart",alias:"widget.wipchart",itemId:"rally-chart",chartData:{},loadMask:!1,chartColors:[],chartConfig:{colors:["#00a9e0","#8dc63f"],chart:{type:"bar"},title:{text:"WIP Limits Chart"},xAxis:{},yAxis:[{title:{text:"Under / Over WIP Limits"}}],plotOptions:{series:{dataLabels:{enabled:!0,color:"#FFFFFF"},stacking:"normal"}}},constructor:function(config){this.callParent(arguments),config.title&&(this.chartConfig.title=config.title)}});

            Rally.launchApp('CustomApp', {
                name:"wip-limits-chart",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
