<!DOCTYPE html>
<html>
<head>
    <title>wip-limits-chart</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("RallyFunctions",function(){var self;return{config:{ctx:{}},constructor:function(config){return self=this,this.initConfig(config),this},_wsapiQuery:function(config,callback){var storeConfig={autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}};_.isUndefined(config.context)||(storeConfig.context=config.context),Ext.create("Rally.data.WsapiDataStore",storeConfig)},createFilter:function(releaseName,iterationName){var filter=null;if(_.isNull(releaseName)||(filter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operator:"=",value:releaseName})),!_.isNull(iterationName)){var ifilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",operator:"=",value:iterationName});filter=_.isNull(filter)?ifilter:filter.and(ifilter)}return filter},createFeatureFilter:function(releaseName){var filter=null;return _.isNull(releaseName)||(filter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operator:"=",value:releaseName})),filter},subscribe:function(app){app.subscribe(app,"timeboxReleaseChanged",app._timeboxChanged,app),app.subscribe(app,"timeboxIterationChanged",app._timeboxChanged,app)}}});
                Ext.define("ProjectStories",function(){var self;return{config:{ctx:{},filter:null,featureFilter:null},constructor:function(config){return self=this,this.initConfig(config),this},readProjectStories:function(callback){var fns=[self.readStates.bind(self),self.readProjects.bind(self),self.getReportProjects.bind(self),self.readStories.bind(self)];null!==self.featureFilter&&(fns=[self.readStates.bind(self),self.readFeatureTypes.bind(self),self.readProjects.bind(self),self.getReportProjects.bind(self),self.readStories.bind(self),self.readFeatures.bind(self)]),async.waterfall(fns,function(err,result){callback(null,self.stories,self.reportProjects,self.scheduleStates,self.features)})},readStates:function(callback){var that=this;Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records,operation,success){self.scheduleStates=_.map(records,function(r){return r.get("StringValue")}),callback(null)}})}})},readFeatureTypes:function(callback){var that=this,configs=[{model:"TypeDefinition",fetch:!0,filters:[{property:"Ordinal",operator:"=",value:0}]}];async.map(configs,self._wsapiQuery,function(err,results){self.featureType=_.first(_.first(results)).get("TypePath"),callback(null)})},readProjects:function(callback){var that=this,config={model:"Project",fetch:!0,filters:[]};self._wsapiQuery(config,callback)},getReportProjects:function(projects,callback){self.projects=projects,self.reportProjects=_.filter(projects,function(project){return self._isChildOf(project,self.ctx.getProject())}),0===self.reportProjects.length&&self.reportProjects.push(_.find(self.projects,function(project){return project.get("ObjectID")===self.ctx.getProject().ObjectID})),callback(null)},readStories:function(callback){var configs=_.map(self.reportProjects,function(project){return{model:"HierarchicalRequirement",filters:[self.filter],fetch:["ObjectID","ScheduleState","PlanEstimate","Project"],context:{project:project.get("_ref"),projectScopeUp:!1,projectScopeDown:!0}}});async.map(configs,self._wsapiQuery,function(error,results){self.stories=results,callback(null)})},readFeatures:function(callback){var configs=_.map(self.reportProjects,function(project){return{model:self.featureType,filters:[self.featureFilter],fetch:["FormattedID","Name","ObjectID","LeafStoryCount","LeafStoryPlanEstimateTotal","PreliminaryEstimate","AcceptedLeafStoryCount","AcceptedLeafStoryPlanEstimateTotal","PercentDoneByStoryCount","c_ValueMetricKPI","Rank"],order:[{property:"DragAndDropRank",direction:"ASC"}],context:{project:project.get("_ref"),projectScopeUp:!1,projectScopeDown:!0}}});async.map(configs,self._wsapiQuery,function(error,results){self.features=results,callback(null)})},_wsapiQuery:function(config,callback){var storeConfig={autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}};_.isUndefined(config.context)||(storeConfig.context=config.context),_.isUndefined(config.order)||(storeConfig.order=config.order),Ext.create("Rally.data.WsapiDataStore",storeConfig)},_isChildOf:function(child,parent){var childParentRef=_.isNull(child.get("Parent"))?"null":child.get("Parent")._ref;return parent._ref.indexOf(childParentRef)>-1}}});
                Ext.define("timebox-selector",{extend:"Ext.Container",componentCls:"app",alias:"widget.timebox-selector",cls:"timebox-selector",layout:"hbox",width:"100%",mixins:["Rally.Messageable"],constructor:function(){this.stateId=Rally.environment.getContext().getScopedStateId("timebox-filter"),this.callParent(arguments)},initComponent:function(){this.callParent(arguments),this._createReleaseCombo(),this.addEvents("releasechange","iterationchange"),this.subscribe(this,"requestTimebox",this._requestTimebox,this)},_createReleaseCombo:function(){this._releaseCombo=this.add({xtype:"rallyreleasecombobox",fieldLabel:"Program Increment",hideLabel:!1,labelPad:5,labelSeparator:":",labelWidth:130,width:280,labelAlign:"right",stateful:!1,stateId:"releasecombo",padding:5,context:Rally.environment.getContext(),showArrows:!1,growToLongestValue:!0,defaultToCurrentTimebox:!0,listeners:{change:function(t,newVal,oldVal,eOpts){var release=t.getRecord();this.fireEvent("releasechange",release),this.publish("timeboxReleaseChanged",release),this._updateIterationCombo(release)},scope:this}})},_updateIterationCombo:function(release){this.remove("globaliterationpicker");var endFilter=Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<=",value:Rally.util.DateTime.toIsoString(release.get("ReleaseDate"))}),startFilter=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:">=",value:Rally.util.DateTime.toIsoString(release.get("ReleaseStartDate"))}),filters=endFilter.and(startFilter);this._iterationCombo=this.add({xtype:"rallyiterationcombobox",itemId:"globaliterationpicker",fieldLabel:"Sprint/Iteration",hideLabel:!1,labelPad:5,labelSeparator:":",labelWidth:100,labelAlign:"right",stateful:!1,padding:5,context:Rally.environment.getContext(),showArrows:!1,growToLongestValue:!0,stateId:"iterationcombo",allowBlank:!0,allowClear:!0,allowNoEntry:!0,noEntryText:"PI Scope",emptyText:"PI Scope",noEntryValue:null,defaultToCurrentTimebox:!1,defaultSelectPosition:"first",storeConfig:{remoteFilter:!0,filters:filters},listeners:{change:function(t,newVal,oldVal,eOpts){var iteration=t.getRecord();this.fireEvent("iterationchange",iteration),this.publish("timeboxIterationChanged",iteration)},scope:this}})},_requestTimebox:function(source){console.log("Got request timebox message",source);var release=this.getReleaseRecord();console.log("release",release),release&&this.publish("timeboxReleaseChanged",release);var iteration=this.getIterationRecord();console.log("iteration",iteration),iteration&&this.publish("timeboxIterationChanged",iteration)},getReleaseRecord:function(){return this._releaseCombo?this._releaseCombo.getRecord()||null:null},getIterationRecord:function(){return this._iterationCombo?this._iterationCombo.getRecord()||null:null}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"settings_box"},{xtype:"container",itemId:"selector_box"}],config:{defaultSettings:{stacking:!0,showScopeSelector:!1}},launch:function(){this.isExternal()?this.showSettings(this.config):this.onSettingsUpdate(this.getSettings())},_launch:function(settings){console.log("_launch");var that=this;console.log("Settings:",settings),settings.showScopeSelector===!0||"true"===settings.showScopeSelector?this.down("#selector_box").add({xtype:"timebox-selector",context:this.getContext(),listeners:{releasechange:function(release){this._changeRelease(release)},iterationchange:function(iteration){this._changeIteration(iteration)},scope:this}}):(this.subscribe(this,"timeboxReleaseChanged",this._changeRelease,this),this.subscribe(this,"timeboxIterationChanged",this._changeIteration,this),this.publish("requestTimebox",this)),that.run(release,iteration)},_changeRelease:function(release){this.run(release.get("Name"),null)},_changeIteration:function(iteration){this.run(null,iteration.get("Name"),null)},run:function(releaseName,iterationName){var that=this;that.rallyFunctions=Ext.create("RallyFunctions");var pr=Ext.create("ProjectStories",{ctx:that.getContext(),filter:that.rallyFunctions.createFilter(releaseName,iterationName)});pr.readProjectStories(function(error,stories,projects,states){that.readWipValues(projects,function(error,wipLimits){that.prepareChartData(stories,projects,wipLimits,function(error,categories,series){that.createChart(categories,series)})})})},_timeboxChanged:function(timebox){var that=this;console.log("WIP Limits Chart:_timeboxChanged received"),"release"===timebox.get("_type")?that.run(timebox.get("Name"),null):that.run(null,timebox.get("Name"))},getTimeboxScope:function(){var timeboxScope=this.getContext().getTimeboxScope();return timeboxScope?{type:timeboxScope.getType(),name:timeboxScope.getRecord().get("Name")}:null},onTimeboxScopeChange:function(newTimeboxScope){this.callParent(arguments),newTimeboxScope&&"iteration"===newTimeboxScope.getType()?this.run(null,newTimeboxScope.getRecord().get("Name")):newTimeboxScope&&"release"===newTimeboxScope.getType()&&this.run(newTimeboxScope.getRecord().get("Name"),null)},readWipValues:function(projects,callback){var that=this,projectKeys=_.map(projects,function(p){return p.get("Name")}),states=["In-Progress","Completed"],keys=_.flatten(_.map(projectKeys,function(pKey){return _.map(states,function(state){return"project-wip:"+pKey+":"+state+"WIP"})})),configs=_.map(keys,function(key){return{model:"Preference",filters:[{property:"Name",operator:"=",value:key}],fetch:!0}});async.map(configs,that.rallyFunctions._wsapiQuery,function(error,results){callback(null,_.flatten(results))})},prepareChartData:function(stories,projects,wipLimits,callback){var that=this,categories=_.map(projects,function(p){return _.last(p.get("Name").split(">"))}),states=["In-Progress","Completed"],pointsValue=function(value){return _.isUndefined(value)||_.isNull(value)?0:value},summarize=function(workItems,states){var stateTotal=_.reduce(workItems,function(memo,workItem){return memo+(_.indexOf(states,workItem.get("ScheduleState"))>-1?1:0)},0);return stateTotal},wipForProjectAndState=function(project,state){var wip=_.find(wipLimits,function(limit){return-1!==limit.get("Name").indexOf(project.get("Name"))&&-1!==limit.get("Name").indexOf(state)});if(_.isUndefined(wip)||_.isNull(wip))return 0;var val=wip.get("Value").replace(/"/g,"");return parseInt(val,10)},seriesData=_.map(states,function(state){var counts=_.map(categories,function(project,index){return summarize(stories[index],[state])}),wips=_.map(categories,function(project,index){return wipForProjectAndState(projects[index],state)});return{name:state,data:_.map(categories,function(project,index){return counts[index]-wips[index]})}});callback(null,categories,seriesData)},createChart:function(categories,seriesData,callback){var that=this;_.isUndefined(that.chart)||that.remove(that.chart),that.chart=Ext.create("Rally.technicalservices.wipChart",{itemId:"rally-chart",chartData:{series:seriesData,categories:categories},title:"WIP Limits by Projecgt",stacking:that.getSetting("stacking")}),that.add(that.chart);var chart=this.down("#rally-chart"),p=Ext.get(chart.id);elems=p.query("div.x-mask"),_.each(elems,function(e){e.remove()});var elems=p.query("div.x-mask-msg");_.each(elems,function(e){e.remove()})},isExternal:function(){return this.getAppId()===void 0},showSettings:function(options){return this._appSettings=Ext.create("Rally.app.AppSettings",Ext.apply({fields:this.getSettingsFields(),settings:this.getSettings(),defaultSettings:this.getDefaultSettings(),context:this.getContext(),settingsScope:this.settingsScope,autoScroll:!0},options)),this._appSettings.on("cancel",this._hideSettings,this),this._appSettings.on("save",this._onSettingsSaved,this),this.isExternal()?void 0===this.down("#settings_box").getComponent(this._appSettings.id)&&this.down("#settings_box").add(this._appSettings):(this.hide(),this.up().add(this._appSettings)),this._appSettings},_onSettingsSaved:function(settings){Ext.apply(this.settings,settings),this._hideSettings(),this.onSettingsUpdate(settings)},onSettingsUpdate:function(settings){console.log("onSettingsUpdate",settings),Ext.apply(this,settings),this._launch(settings)},getSettingsFields:function(){return[{name:"showScopeSelector",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 200",boxLabel:'Show Scope Selector<br/><span style="color:#999999;"><i>Tick to use this to broadcast settings.</i></span>'},{name:"stacking",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 200",boxLabel:"If true the chart values will be stacked, otherwise shown side by side"}]}});
                Ext.define("Rally.technicalservices.wipChart",{extend:"Rally.ui.chart.Chart",alias:"widget.wipchart",itemId:"rally-chart",chartData:{},loadMask:!1,chartColors:[],chartConfig:{colors:["#00a9e0","#8dc63f"],chart:{type:"bar"},title:{text:"WIP Limits Chart"},xAxis:{},yAxis:[{title:{text:"Under / Over WIP Limits"}}],plotOptions:{series:{dataLabels:{enabled:!0,color:"#FFFFFF"},stacking:"normal"}}},constructor:function(config){this.callParent(arguments),config.title&&(this.chartConfig.title=config.title),_.isUndefined(config.stacking)||(this.chartConfig.plotOptions.series.stacking=config.stacking===!0?"normal":null)}});
                (function(){var a={},b=this,c=b.async;"undefined"!=typeof module&&module.exports?module.exports=a:b.async=a,a.noConflict=function(){return b.async=c,a};var d=function(a,b){if(a.forEach)return a.forEach(b);for(var c=0;a.length>c;c+=1)b(a[c],c,a)},e=function(a,b){if(a.map)return a.map(b);var c=[];return d(a,function(a,d,e){c.push(b(a,d,e))}),c},f=function(a,b,c){return a.reduce?a.reduce(b,c):(d(a,function(a,d,e){c=b(c,a,d,e)}),c)},g=function(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b};a.nextTick="undefined"!=typeof process&&process.nextTick?process.nextTick:function(a){setTimeout(a,0)},a.forEach=function(a,b,c){if(c=c||function(){},!a.length)return c();var e=0;d(a,function(d){b(d,function(b){b?(c(b),c=function(){}):(e+=1,e===a.length&&c(null))})})},a.forEachSeries=function(a,b,c){if(c=c||function(){},!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d===a.length?c(null):e())})};e()},a.forEachLimit=function(a,b,c,d){if(d=d||function(){},!a.length||0>=b)return d();var e=0,f=0,g=0;(function h(){if(e===a.length)return d();for(;b>g&&a.length>f;)f+=1,g+=1,c(a[f-1],function(b){b?(d(b),d=function(){}):(e+=1,g-=1,e===a.length?d():h())})})()};var h=function(b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[a.forEach].concat(c))}},i=function(b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[a.forEachSeries].concat(c))}},j=function(a,b,c,d){var f=[];b=e(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c,d){f[a.index]=d,b(c)})},function(a){d(a,f)})};a.map=h(j),a.mapSeries=i(j),a.reduce=function(b,c,d,e){a.forEachSeries(b,function(a,b){d(c,a,function(a,d){c=d,b(a)})},function(a){e(a,c)})},a.inject=a.reduce,a.foldl=a.reduce,a.reduceRight=function(b,c,d,f){var g=e(b,function(a){return a}).reverse();a.reduce(g,c,d,f)},a.foldr=a.reduceRight;var k=function(a,b,c,d){var f=[];b=e(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c&&f.push(a),b()})},function(a){d(e(f.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};a.filter=h(k),a.filterSeries=i(k),a.select=a.filter,a.selectSeries=a.filterSeries;var l=function(a,b,c,d){var f=[];b=e(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c||f.push(a),b()})},function(a){d(e(f.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};a.reject=h(l),a.rejectSeries=i(l);var m=function(a,b,c,d){a(b,function(a,b){c(a,function(c){c?(d(a),d=function(){}):b()})},function(a){d()})};a.detect=h(m),a.detectSeries=i(m),a.some=function(b,c,d){a.forEach(b,function(a,b){c(a,function(a){a&&(d(!0),d=function(){}),b()})},function(a){d(!1)})},a.any=a.some,a.every=function(b,c,d){a.forEach(b,function(a,b){c(a,function(a){a||(d(!1),d=function(){}),b()})},function(a){d(!0)})},a.all=a.every,a.sortBy=function(b,c,d){a.map(b,function(a,b){c(a,function(c,d){c?b(c):b(null,{value:a,criteria:d})})},function(a,b){if(a)return d(a);var c=function(a,b){var c=a.criteria,d=b.criteria;return d>c?-1:c>d?1:0};d(null,e(b.sort(c),function(a){return a.value}))})},a.auto=function(a,b){b=b||function(){};var c=g(a);if(!c.length)return b(null);var e={},h=[],i=function(a){h.unshift(a)},j=function(a){for(var b=0;h.length>b;b+=1)if(h[b]===a)return h.splice(b,1),void 0},k=function(){d(h.slice(0),function(a){a()})};i(function(){g(e).length===c.length&&(b(null,e),b=function(){})}),d(c,function(c){var d=a[c]instanceof Function?[a[c]]:a[c],g=function(a){if(a)b(a),b=function(){};else{var d=Array.prototype.slice.call(arguments,1);1>=d.length&&(d=d[0]),e[c]=d,k()}},h=d.slice(0,Math.abs(d.length-1))||[],l=function(){return f(h,function(a,b){return a&&e.hasOwnProperty(b)},!0)&&!e.hasOwnProperty(c)};if(l())d[d.length-1](g,e);else{var m=function(){l()&&(j(m),d[d.length-1](g,e))};i(m)}})},a.waterfall=function(b,c){if(c=c||function(){},!b.length)return c();var d=function(b){return function(e){if(e)c(e),c=function(){};else{var f=Array.prototype.slice.call(arguments,1),g=b.next();g?f.push(d(g)):f.push(c),a.nextTick(function(){b.apply(null,f)})}}};d(a.iterator(b))()},a.parallel=function(b,c){if(c=c||function(){},b.constructor===Array)a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);1>=c.length&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.forEach(g(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);1>=e.length&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}},a.series=function(b,c){if(c=c||function(){},b.constructor===Array)a.mapSeries(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);1>=c.length&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.forEachSeries(g(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);1>=e.length&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}},a.iterator=function(a){var b=function(c){var d=function(){return a.length&&a[c].apply(null,arguments),d.next()};return d.next=function(){return a.length-1>c?b(c+1):null},d};return b(0)},a.apply=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b.concat(Array.prototype.slice.call(arguments)))}};var n=function(a,b,c,d){var e=[];a(b,function(a,b){c(a,function(a,c){e=e.concat(c||[]),b(a)})},function(a){d(a,e)})};a.concat=h(n),a.concatSeries=i(n),a.whilst=function(b,c,d){b()?c(function(e){return e?d(e):(a.whilst(b,c,d),void 0)}):d()},a.until=function(b,c,d){b()?d():c(function(e){return e?d(e):(a.until(b,c,d),void 0)})},a.queue=function(b,c){var e=0,f={tasks:[],concurrency:c,saturated:null,empty:null,drain:null,push:function(b,e){b.constructor!==Array&&(b=[b]),d(b,function(b){f.tasks.push({data:b,callback:"function"==typeof e?e:null}),f.saturated&&f.tasks.length==c&&f.saturated(),a.nextTick(f.process)})},process:function(){if(f.concurrency>e&&f.tasks.length){var a=f.tasks.shift();f.empty&&0==f.tasks.length&&f.empty(),e+=1,b(a.data,function(){e-=1,a.callback&&a.callback.apply(a,arguments),f.drain&&0==f.tasks.length+e&&f.drain(),f.process()})}},length:function(){return f.tasks.length},running:function(){return e}};return f};var o=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);b.apply(null,c.concat([function(b){var c=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(b?console.error&&console.error(b):console[a]&&d(c,function(b){console[a](b)}))}]))}};a.log=o("log"),a.dir=o("dir"),a.memoize=function(a,b){var c={},d={};b=b||function(a){return a};var e=function(){var e=Array.prototype.slice.call(arguments),f=e.pop(),g=b.apply(null,e);g in c?f.apply(null,c[g]):g in d?d[g].push(f):(d[g]=[f],a.apply(null,e.concat([function(){c[g]=arguments;var a=d[g];delete d[g];for(var b=0,e=a.length;e>b;b++)a[b].apply(null,arguments)}])))};return e.unmemoized=a,e},a.unmemoize=function(a){return function(){return(a.unmemoized||a).apply(null,arguments)}}})();

            Rally.launchApp('CustomApp', {
                name:"wip-limits-chart",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
