<!DOCTYPE html>
<html>
<head>
    <title>pyramid-success-chart</title>

    <script type="text/javascript" src="https://10.32.16.145/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>
    <script type="text/javascript" src="https://code.highcharts.com/highcharts.js"></script>
    <script type="text/javascript" src="https://code.highcharts.com/modules/funnel.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("RallyFunctions",function(){var self;return{config:{ctx:{}},constructor:function(config){return self=this,this.initConfig(config),this},_wsapiQuery:function(config,callback){var storeConfig={autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}};_.isUndefined(config.context)||(storeConfig.context=config.context),Ext.create("Rally.data.WsapiDataStore",storeConfig)},createFilter:function(releaseName,iterationName){var filter=null;if(_.isNull(releaseName)||(filter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operator:"=",value:releaseName})),!_.isNull(iterationName)){var ifilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",operator:"=",value:iterationName});filter=_.isNull(filter)?ifilter:filter.and(ifilter)}return filter}}});
                Ext.define("ProjectStories",function(){var self;return{config:{ctx:{},filter:null},constructor:function(config){return self=this,this.initConfig(config),this},readProjectStories:function(callback){var fns=[self.readStates.bind(self),self.readProjects.bind(self),self.getReportProjects.bind(self),self.readStories.bind(self)];async.waterfall(fns,function(err,result){console.log("result",result),callback(null,result,self.reportProjects,self.scheduleStates)})},readStates:function(callback){var that=this;Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records,operation,success){self.scheduleStates=_.map(records,function(r){return r.get("StringValue")}),callback(null)}})}})},readProjects:function(callback){var that=this,config={model:"Project",fetch:!0,filters:[]};self._wsapiQuery(config,callback)},getReportProjects:function(projects,callback){self.projects=projects,self.reportProjects=_.filter(projects,function(project){return self._isChildOf(project,self.ctx.getProject())}),0===self.reportProjects.length&&self.reportProjects.push(_.find(self.projects,function(project){return project.get("ObjectID")===self.ctx.getProject().ObjectID})),callback(null)},readStories:function(callback){var configs=_.map(self.reportProjects,function(project){return{model:"HierarchicalRequirement",filters:[self.filter],fetch:["ObjectID","ScheduleState","PlanEstimate","Project"],context:{project:project.get("_ref"),projectScopeUp:!1,projectScopeDown:!0}}});async.map(configs,self._wsapiQuery,function(error,results){callback(null,results)})},_wsapiQuery:function(config,callback){var storeConfig={autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}};_.isUndefined(config.context)||(storeConfig.context=config.context),Ext.create("Rally.data.WsapiDataStore",storeConfig)},_isChildOf:function(child,parent){var childParentRef=_.isNull(child.get("Parent"))?"null":child.get("Parent")._ref;return parent._ref.indexOf(childParentRef)>-1}}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var that=this,release=null,iteration="Iteration 1";that.rallyFunctions=Ext.create("RallyFunctions");var tbs=that.getTimeboxScope();_.isNull(tbs)||(release="release"===tbs.type?tbs.name:null,iteration="iteration"===tbs.type?tbs.name:null),that.run(release,iteration)},run:function(releaseName,iterationName){var that=this,pr=Ext.create("ProjectStories",{ctx:that.getContext(),filter:that.rallyFunctions.createFilter(releaseName,iterationName)});pr.readProjectStories(function(error,stories,projects,states){that.prepareChartData(stories,projects,states,function(error,series,categories){that.createChart(series,categories)})})},getTimeboxScope:function(){var timeboxScope=this.getContext().getTimeboxScope();return timeboxScope?{type:timeboxScope.getType(),name:timeboxScope.getRecord().get("Name")}:null},onTimeboxScopeChange:function(newTimeboxScope){this.callParent(arguments),newTimeboxScope&&"iteration"===newTimeboxScope.getType()?this.run(null,newTimeboxScope.getRecord().get("Name")):newTimeboxScope&&"release"===newTimeboxScope.getType()&&this.run(newTimeboxScope.getRecord().get("Name"),null)},prepareChartData:function(stories,projects,states,callback){var that=this,categories=_.map(projects,function(p){return p.get("Name")}),completedStates=["Accepted",_.last(states)],pointsValue=function(value){return _.isUndefined(value)||_.isNull(value)?0:value},summarize=function(workItems,states){var stateTotal=_.reduce(workItems,function(memo,workItem){return memo+(_.indexOf(states,workItem.get("ScheduleState"))>-1?pointsValue(workItem.get("PlanEstimate")):0)},0);return stateTotal},data=_.map(categories,function(project,index){return[project,summarize(stories[index],states),summarize(stories[index],completedStates)]}),sortedData=data.sort(function(a,b){return b[1]-a[1]}),seriesData=[{name:"Project Scope",data:sortedData,completedData:_.map(sortedData,function(d){return d[2]})}];callback(null,categories,seriesData)},createChart:function(categories,seriesData,callback){var that=this,chartConfig={colors:["#3498db","#f1c40f","#c0392b","#9b59b6","#2ecc71"],chart:{type:"pyramid",marginRight:100},title:{text:"Success Chart"},plotOptions:{pyramid:{allowPointSelect:!0},series:{dataLabels:{enabled:!0,formatter:function(){console.log(this);var scope=this.point.y,completed=this.point.series.options.completedData[this.point.index],pct=Math.round(scope>0?100*(completed/scope):0);return" ["+completed+"/"+scope+"] ("+pct+"%) "+_.last(this.point.name.split(">"))},softConnector:!0,distance:10}}},legend:{enabled:!1},series:seriesData};_.isUndefined(that.x)||that.remove(that.x),that.x=Ext.widget("container",{autoShow:!0,shadow:!1,title:"",resizable:!1,margin:10,html:'<div id="chart-container" class="chart-container"></div>',listeners:{resize:function(panel){},afterrender:function(panel){$("#chart-container").highcharts(chartConfig)}}}),that.add(that.x)}});

            Rally.launchApp('CustomApp', {
                name:"pyramid-success-chart",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .chart-container{width:600px;height:400px}
    </style>
</head>
<body>
</body>
</html>
