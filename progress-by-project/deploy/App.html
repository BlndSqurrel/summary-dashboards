<!DOCTYPE html>
<html>
<head>
    <title>progress-by-project</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var release=null,iteration="Iteration 1",that=this;console.log(that.getContext(),that.getContext().getProject()),that.run(release,iteration)},run:function(releaseName,iterationName){var that=this;that.workItemFilter=that.createFilter(releaseName,iterationName),console.log(""+that.workItemFilter);var fns=[that.readProjects.bind(that),that.getReportProjects.bind(that),that.readWorkItems.bind(that),that.groupWorkItems.bind(that),that.prepareChartData.bind(that),that.createChart.bind(that)];async.waterfall(fns,function(err,result){console.log("result",result)})},getTimeboxScope:function(){var timeboxScope=this.getContext().getTimeboxScope();if(timeboxScope&&"iteration"===timeboxScope.getType()){var record=timeboxScope.getRecord(),name=record.get("Name");return name}return null},readProjects:function(callback){var that=this,config={model:"Project",fetch:!0,filters:[]};that._wsapiQuery(config,callback)},getReportProjects:function(projects,callback){var that=this;that.projects=projects,that.reportProjects=_.filter(projects,function(project){return that._isChildOf(project,that.getContext().getProject())}),console.log("report:",_.map(that.reportProjects,function(p){return p.get("Name")})),callback(null)},readWorkItems:function(callback){var that=this,configs=_.map(["HierarchicalRequirement","Defect"],function(model){return{model:model,filters:[that.workItemFilter],fetch:["ObjectID","ScheduleState","PlanEstimate","Project"]}});console.log("configs",configs),async.map(configs,that._wsapiQuery,function(error,results){var allItems=[];_.each(results,function(result){allItems=allItems.concat(result)}),callback(null,allItems)})},groupWorkItems:function(workItems,callback){var that=this,groupedByParent=_.groupBy(workItems,function(workItem){var p=_.find(that.projects,function(allProject){return workItem.get("Project").ObjectID===allProject.get("ObjectID")}),reportProject=_.find(that.reportProjects,function(reportP){return reportP.get("_ref")===p.get("_ref")?!0:_.isNull(p.get("Parent"))||p.get("Parent")._ref!==reportP.get("_ref")?!1:!0});return _.isUndefined(reportProject)||_.isNull(reportProject)?"None":reportProject.get("Name")});callback(null,groupedByParent)},prepareChartData:function(groupedWorkItems,callback){var projectKeys=_.compact(_.map(_.keys(groupedWorkItems),function(k){return"None"!==k?k:null})),pointsValue=function(value){return _.isUndefined(value)||_.isNull(value)?0:value},summarize=function(workItems,states){var total=_.reduce(workItems,function(memo,workItem){return memo+pointsValue(workItem.get("PlanEstimate"))},0),stateTotal=_.reduce(workItems,function(memo,workItem){return memo+(_.indexOf(states,workItem.get("ScheduleState"))>-1?pointsValue(workItem.get("PlanEstimate")):0)},0),p=total>0?100*(stateTotal/total):0;return Math.round(100*p)/100},summary={Backlog:["Defined"],"In-Progress":["In-Progress"],"Completed/Accepted":["Completed","Accepted"]},categories=projectKeys,seriesData=_.map(_.keys(summary),function(summaryKey){return{name:summaryKey,data:_.map(projectKeys,function(projectKey){return summarize(groupedWorkItems[projectKey],summary[summaryKey])})}});callback(null,categories,seriesData)},createChart:function(categories,seriesData,callback){var that=this,chart=Ext.create("Rally.technicalservices.bmChart",{itemId:"rally-chart",chartData:{series:seriesData,categories:categories},chartColors:[],title:"Kickbacks and Deletions"});that.add(chart)},createFilter:function(releaseName,iterationName){var filter=null;if(_.isNull(releaseName)||(filter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operator:"=",value:releaseName})),!_.isNull(iterationName)){var ifilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",operator:"=",value:iterationName});filter=_.isNull(filter)?ifilter:filter.and(ifilter)}return filter},_isChildOf:function(child,parent){var childParentRef=_.isNull(child.get("Parent"))?"null":child.get("Parent")._ref;return parent._ref.indexOf(childParentRef)>-1},_wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}});
                Ext.define("Rally.technicalservices.bmChart",{extend:"Rally.ui.chart.Chart",alias:"widget.bmchart",itemId:"rally-chart",chartData:{},loadMask:!1,chartColors:[],chartConfig:{chartColors:[],chart:{type:"bar"},title:{text:"Progress by Project"},xAxis:{tickInterval:1,title:{text:"%"}},yAxis:[{min:0,max:100,title:{text:"% of Scheduled Stories by State"}}],plotOptions:{series:{dataLabels:{enabled:!0,align:"center",format:"{y}%",color:"#FFFFFF"},stacking:"normal"}}},constructor:function(config){this.callParent(arguments),config.title&&(this.chartConfig.title=config.title)}});

            Rally.launchApp('CustomApp', {
                name:"progress-by-project",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
