<!DOCTYPE html>
<html>
<head>
    <title>progress-by-project</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("RallyFunctions",function(){var self;return{config:{ctx:{}},constructor:function(config){return self=this,this.initConfig(config),this},_wsapiQuery:function(config,callback){var storeConfig={autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}};_.isUndefined(config.context)||(storeConfig.context=config.context),Ext.create("Rally.data.WsapiDataStore",storeConfig)},createFilter:function(releaseName,iterationName){var filter=null;if(_.isNull(releaseName)||(filter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operator:"=",value:releaseName})),!_.isNull(iterationName)){var ifilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",operator:"=",value:iterationName});filter=_.isNull(filter)?ifilter:filter.and(ifilter)}return filter},createFeatureFilter:function(releaseName){var filter=null;return _.isNull(releaseName)||(filter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operator:"=",value:releaseName})),filter},subscribe:function(app){app.subscribe(app,"timeboxReleaseChanged",app._timeboxChanged,app),app.subscribe(app,"timeboxIterationChanged",app._timeboxChanged,app)}}});
                Ext.define("ProjectStories",function(){var self;return{config:{ctx:{},filter:null,featureFilter:null},constructor:function(config){return self=this,this.initConfig(config),this},readProjectStories:function(callback){var fns=[self.readStates.bind(self),self.readProjects.bind(self),self.getReportProjects.bind(self),self.readStories.bind(self)];null!==self.featureFilter&&(fns=[self.readStates.bind(self),self.readFeatureTypes.bind(self),self.readProjects.bind(self),self.getReportProjects.bind(self),self.readStories.bind(self),self.readFeatures.bind(self)]),async.waterfall(fns,function(err,result){callback(null,self.stories,self.reportProjects,self.scheduleStates,self.features)})},readStates:function(callback){var that=this;Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records,operation,success){self.scheduleStates=_.map(records,function(r){return r.get("StringValue")}),callback(null)}})}})},readFeatureTypes:function(callback){var that=this,configs=[{model:"TypeDefinition",fetch:!0,filters:[{property:"Ordinal",operator:"=",value:0}]}];async.map(configs,self._wsapiQuery,function(err,results){self.featureType=_.first(_.first(results)).get("TypePath"),callback(null)})},readProjects:function(callback){var that=this,config={model:"Project",fetch:!0,filters:[]};self._wsapiQuery(config,callback)},getReportProjects:function(projects,callback){self.projects=projects,self.reportProjects=_.filter(projects,function(project){return self._isChildOf(project,self.ctx.getProject())}),0===self.reportProjects.length&&self.reportProjects.push(_.find(self.projects,function(project){return project.get("ObjectID")===self.ctx.getProject().ObjectID})),callback(null)},readStories:function(callback){var configs=_.map(self.reportProjects,function(project){return{model:"HierarchicalRequirement",filters:[self.filter],fetch:["ObjectID","ScheduleState","PlanEstimate","Project"],context:{project:project.get("_ref"),projectScopeUp:!1,projectScopeDown:!0}}});async.map(configs,self._wsapiQuery,function(error,results){self.stories=results,callback(null)})},readFeatures:function(callback){var configs=_.map(self.reportProjects,function(project){return{model:self.featureType,filters:[self.featureFilter],fetch:["FormattedID","Name","ObjectID","LeafStoryCount","LeafStoryPlanEstimateTotal","PreliminaryEstimate","AcceptedLeafStoryCount","AcceptedLeafStoryPlanEstimateTotal","PercentDoneByStoryCount","c_ValueMetricKPI","Rank"],order:[{property:"DragAndDropRank",direction:"ASC"}],context:{project:project.get("_ref"),projectScopeUp:!1,projectScopeDown:!0}}});async.map(configs,self._wsapiQuery,function(error,results){self.features=results,callback(null)})},_wsapiQuery:function(config,callback){var storeConfig={autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}};_.isUndefined(config.context)||(storeConfig.context=config.context),_.isUndefined(config.order)||(storeConfig.order=config.order),Ext.create("Rally.data.WsapiDataStore",storeConfig)},_isChildOf:function(child,parent){var childParentRef=_.isNull(child.get("Parent"))?"null":child.get("Parent")._ref;return parent._ref.indexOf(childParentRef)>-1}}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var that=this,release=null,iteration="Iteration 1";that.rallyFunctions=Ext.create("RallyFunctions"),that.rallyFunctions.subscribe(that);var tbs=that.getTimeboxScope();_.isNull(tbs)||(release="release"===tbs.type?tbs.name:null,iteration="iteration"===tbs.type?tbs.name:null),that.run(release,iteration)},run:function(releaseName,iterationName){var that=this,pr=Ext.create("ProjectStories",{ctx:that.getContext(),filter:that.rallyFunctions.createFilter(releaseName,iterationName)});pr.readProjectStories(function(error,stories,projects,states){that.prepareChartData(stories,projects,states,function(error,categories,series){that.createChart(categories,series)})})},_timeboxChanged:function(timebox){var that=this;console.log("Progress-By-Project:_timeboxChanged received"),"release"===timebox.get("_type")?that.run(timebox.get("Name"),null):that.run(null,timebox.get("Name"))},getTimeboxScope:function(){var timeboxScope=this.getContext().getTimeboxScope();return timeboxScope?{type:timeboxScope.getType(),name:timeboxScope.getRecord().get("Name")}:null},onTimeboxScopeChange:function(newTimeboxScope){this.callParent(arguments),newTimeboxScope&&"iteration"===newTimeboxScope.getType()?this.run(null,newTimeboxScope.getRecord().get("Name")):newTimeboxScope&&"release"===newTimeboxScope.getType()&&this.run(newTimeboxScope.getRecord().get("Name"),null)},prepareChartData:function(stories,projects,states,callback){var that=this,projectKeys=_.map(projects,function(project){return _.last(project.get("Name").split(">"))}),pointsValue=function(value){return _.isUndefined(value)||_.isNull(value)?0:value},summarize=function(workItems,states){var total=_.reduce(workItems,function(memo,workItem){return memo+pointsValue(workItem.get("PlanEstimate"))},0),stateTotal=_.reduce(workItems,function(memo,workItem){return memo+(_.indexOf(states,workItem.get("ScheduleState"))>-1?pointsValue(workItem.get("PlanEstimate")):0)},0),p=total>0?100*(stateTotal/total):0;return Math.round(p)},summary=that.createSummaryRecord(),seriesData=_.map(_.keys(summary),function(summaryKey){return{name:summaryKey,data:_.map(projectKeys,function(projectKey,index){return summarize(stories[index],summary[summaryKey])})}});callback(null,projectKeys,seriesData)},createChart:function(categories,seriesData,callback){var that=this;_.isUndefined(that.chart)||that.remove(that.chart),that.chart=Ext.create("Rally.technicalservices.progressChart",{itemId:"rally-chart",chartData:{series:seriesData,categories:categories},title:"Progress By Project"}),that.add(that.chart);var chart=this.down("#rally-chart"),p=Ext.get(chart.id);elems=p.query("div.x-mask"),_.each(elems,function(e){e.remove()});var elems=p.query("div.x-mask-msg");_.each(elems,function(e){e.remove()})},createSummaryRecord:function(){var that=this,summary={Backlog:["Defined"],"In-Progress":["In-Progress"],"Completed/Accepted":["Completed","Accepted"]},first=_.first(that.scheduleStates),last=_.last(that.scheduleStates);return-1===_.indexOf(summary[_.first(_.keys(summary))],first)&&summary[_.first(_.keys(summary))].push(_.first(that.scheduleStates)),-1===_.indexOf(summary[_.last(_.keys(summary))],last)&&summary[_.last(_.keys(summary))].push(_.last(that.scheduleStates)),summary}});
                Ext.define("Rally.technicalservices.progressChart",{extend:"Rally.ui.chart.Chart",alias:"widget.progresschart",itemId:"rally-chart",chartData:{},loadMask:!1,chartColors:[],chartConfig:{colors:["#E0E0E0","#00a9e0","#8dc63f"],chart:{type:"bar"},title:{text:"Progress by Project"},xAxis:{tickInterval:1,title:{text:"%"}},yAxis:[{min:0,max:100,title:{text:"% of Scheduled Stories by State"}}],plotOptions:{series:{dataLabels:{enabled:!0,align:"center",formatter:function(){return 0!==this.percentage?Math.round(this.percentage)+" %":""},color:"#FFFFFF"},stacking:"normal"}}},constructor:function(config){this.callParent(arguments),config.title&&(this.chartConfig.title=config.title)}});

            Rally.launchApp('CustomApp', {
                name:"progress-by-project",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
