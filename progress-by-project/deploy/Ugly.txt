<!DOCTYPE html>
<html>
<head>
    <title>Progress by Project</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Mon Apr 03 2017 14:34:16 GMT-0700 (PDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Mon Apr 03 2017 14:34:16 GMT-0700 (PDT)";
        var STORY    = "...US1237";
        var BUILDER  = "marjo60";
        var CHECKSUM = 10463377873;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) 
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->
    
    
    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){if(!Ext.isIE9m){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}}),Ext.define("TSProgressByProject",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,items:[{xtype:"container",itemId:"settings_box"},{xtype:"container",itemId:"selector_box",layout:"hbox"}],config:{defaultSettings:{showScopeSelector:!0}},chart:null,launch:function(){Deft.Chain.sequence([this._getPortfolioItemTypes,this._getAvailableStates],this).then({scope:this,success:function(a){var b=(a[1],a[0]);this.bottom_type_path=b[0].get("TypePath"),this._launch(this.getSettings())}})},_launch:function(a){var b=this;b.rallyFunctions=Ext.create("RallyFunctions"),a.showScopeSelector===!0||"true"===a.showScopeSelector?this.down("#selector_box").add({xtype:"timebox-selector",context:this.getContext(),listeners:{releasechange:function(a){this._changeRelease(a)},iterationchange:function(a){this._changeIteration(a)},scope:this}}):(this.subscribe(this,"timeboxReleaseChanged",this._changeRelease,this),this.subscribe(this,"timeboxIterationChanged",this._changeIteration,this),this.publish("requestTimebox",this)),this.getSetting("filterField")&&(this.fieldValuePicker=this.down("#selector_box").add({xtype:"rallyfieldvaluecombobox",fieldLabel:"Restrict "+this.getSetting("filterField")+" to:",labelWidth:225,labelAlign:"right",margin:"7 0 0 25",minWidth:300,value:["zz"],allowClear:!1,setUseNullForNoEntryValue:!0,model:this.bottom_type_path,field:this.getSetting("filterField"),multiSelect:!0,listeners:{scope:this,blur:function(){this.run(this.release&&this.release.get("Name"),this.iteration&&this.iteration.get("Name"))}}}))},_changeRelease:function(a){this.release=a,this.run(a.get("Name"),null)},_changeIteration:function(a){this.iteration=a,Ext.isEmpty(a)||this.run(null,a.get("Name"))},run:function(a,b){this.logger.log("release/iteration",a,b);var c=this;Ext.isEmpty(this.chart)||this.chart.destroy();var d=this._getFeatureFieldName(),e=this.fieldValuePicker&&this.fieldValuePicker.getValue()||[],f=this.getSetting("filterField");this.setLoading("Loading Stories in Project...");var g=c.rallyFunctions.createFilter(a,b,d);if(f&&e&&e.length>0){var h=Ext.Array.map(e,function(a){return"None"==a&&(a=""),{property:d+"."+f,value:a}}),i=Rally.data.wsapi.Filter.or(h);g=g.and(i)}var j=Ext.create("ProjectStories",{ctx:c.getContext(),filter:g});j.readProjectWorkItems(function(a,b,d,e){c.prepareChartData(b,d,e,function(a,b,d){c.createChart(b,d)})})},_timeboxChanged:function(a){var b=this;"release"===a.get("_type")?b.run(a.get("Name"),null):b.run(null,a.get("Name"))},getTimeboxScope:function(){var a=this.getContext().getTimeboxScope();return a?{type:a.getType(),name:a.getRecord().get("Name")}:null},onTimeboxScopeChange:function(a){this.callParent(arguments),a&&"iteration"===a.getType()?this.run(null,a.getRecord().get("Name")):a&&"release"===a.getType()&&this.run(a.getRecord().get("Name"),null)},prepareChartData:function(a,b,c,d){var e=this,f=_.map(b,function(a){return _.last(a.get("Name").split(">"))}),g=function(a){return _.isUndefined(a)||_.isNull(a)?0:a},h=function(a,b){var c=_.reduce(a,function(a,b){return a+g(b.get("PlanEstimate"))},0),d=_.reduce(a,function(a,c){return a+(_.indexOf(b,c.get("ScheduleState"))>-1?g(c.get("PlanEstimate")):0)},0),e=c>0?d/c*100:0;return e},i=e.createSummaryRecord(),j=_.map(_.keys(i),function(b){return{name:b,data:_.map(f,function(c,d){return h(a[d],i[b])})}});d(null,f,j)},createChart:function(a,b,c){var d=this;d.setLoading(!1);var e=this._getPlotLineForCurrentPoint(this.release,this.iteration),f={min:0,max:100,title:{text:"% of Scheduled Stories by State by Points"}};Ext.isEmpty(e)||(f.plotLines=[e]),d.chart=Ext.create("Rally.ui.chart.Chart",{itemId:"rally-chart",chartColors:["#ee6c19","#FAD200","#3F86C9","#8DC63F","#888","#222"],chartData:{series:b,categories:a},chartConfig:{colors:["#ee6c19","#FAD200","#3F86C9","#8DC63F","#888","#222"],chart:{type:"bar"},title:{text:"Progress by Project"},xAxis:{tickInterval:1,title:{text:""}},yAxis:[f],legend:{reversed:!0},plotOptions:{series:{dataLabels:{enabled:!0,align:"center",formatter:function(){return 0!==this.y?Math.round(this.y)+" %":""},color:"#FFFFFF"},stacking:"normal"}},tooltip:{enabled:!1}}}),d.add(d.chart);var g=this.down("#rally-chart"),h=Ext.get(g.id),i=h.query("div.x-mask");_.each(i,function(a){Ext.isIE9?a.removeNode():a.remove()}),i=h.query("div.x-mask-msg"),_.each(i,function(a){Ext.isIE9?a.removeNode():a.remove()})},_getPortfolioItemTypes:function(a){var b=Ext.create("Deft.Deferred"),c={fetch:["Name","ElementName","TypePath"],model:"TypeDefinition",filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],autoLoad:!0,listeners:{load:function(a,c,d){d?b.resolve(c):b.reject("Failed to load types")}}};Ext.isEmpty(a)||(c.context={project:null,workspace:a._ref?a._ref:a.get("_ref")});Ext.create("Rally.data.wsapi.Store",c);return b.promise},_getAvailableStates:function(){var a=Ext.create("Deft.Deferred"),b=this;return this.scheduleStates=[],Rally.data.ModelFactory.getModel({type:"UserStory",success:function(c){c.getField("ScheduleState").getAllowedValueStore().load({callback:function(c,d,e){Ext.Array.each(c,function(a){b.scheduleStates.push(a.get("StringValue"))}),a.resolve(b.scheduleStates)}})}}),a.promise},createSummaryRecord:function(){var a=this,b={};Ext.Array.each(this.scheduleStates,function(a){b[a]=[a]});var c=_.first(a.scheduleStates),d=_.last(a.scheduleStates);return-1===_.indexOf(b[_.first(_.keys(b))],c)&&b[_.first(_.keys(b))].push(_.first(a.scheduleStates)),-1===_.indexOf(b[_.last(_.keys(b))],d)&&b[_.last(_.keys(b))].push(_.last(a.scheduleStates)),b},_getPlotLineForCurrentPoint:function(a,b){if(Ext.isEmpty(b)&&Ext.isEmpty(a))return null;var c=null,d=null,e=null;Ext.isEmpty(a)||(c=a.get("ReleaseStartDate"),d=a.get("ReleaseDate"),e="Release"),Ext.isEmpty(b)||Ext.isEmpty(b.get("StartDate"))||(c=b.get("StartDate"),d=b.get("EndDate"),e="Iteration");var f=new Date,g=Rally.util.DateTime.getDifference(d,c,"day"),h=Rally.util.DateTime.getDifference(f,c,"day"),i=h/g;if(0>i||i>1)return null;var j={value:100*i,color:"green",dashStyle:"shortdash",width:2,label:{text:"today"},zIndex:5};return j},_getFeatureFieldName:function(){var a=this.bottom_type_path||"Feature";return a=a.replace(/^.*\//,"")},getSettingsFields:function(){return[{name:"filterField",xtype:"rallyfieldcombobox",fieldLabel:"Filter Field",labelWidth:85,labelAlign:"left",minWidth:175,margin:25,autoExpand:!1,alwaysExpanded:!1,model:this.bottom_type_path,_isNotHidden:function(a){if(a.hidden)return!1;var b=a.attributeDefinition;return Ext.isEmpty(b)?!1:b.Constrained&&("STRING"==b.AttributeType||"RATING"==b.AttributeType)}},{name:"showScopeSelector",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 200",boxLabel:'Show Scope Selector<br/><span style="color:#999999;"><i>Tick to use this to broadcast settings.</i></span>'}]}}),Ext.define("ProjectStories",function(){var a;return{config:{ctx:{},filter:null,featureFilter:null},constructor:function(b){return a=this,this.initConfig(b),this},readProjectWorkItems:function(b){var c=[a.readStates,a.readProjects,a.readStories];null!==a.featureFilter&&(c=[a.readStates,a.readProjects,a.readFeatures]),Deft.Chain.pipeline(c,a).then({success:function(c){b(null,c,a.projects,a.scheduleStates)},failure:function(a){}})},readStates:function(){var b=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"UserStory",success:function(c){c.getField("ScheduleState").getAllowedValueStore().load({callback:function(c,d,e){a.scheduleStates=_.map(c,function(a){return a.get("StringValue")}),b.resolve(a.scheduleStates)}})}}),b.promise},readProjects:function(b){var c=Ext.create("Deft.Deferred"),d=this;return a._loadAStoreWithAPromise("Project",["_ref","Parent","Children"],[{property:"ObjectID",operator:"=",value:a.ctx.getProject().ObjectID}]).then({scope:d,success:function(b){0===_.first(b).get("Children").Count?(a.projects=b,c.resolve(a.projects)):_.first(b).getCollection("Children").load({fetch:["ObjectID","Name","_ref","Parent","State"],callback:function(b,d,e){a.projects=_.filter(b,function(a){return"Closed"!==a.get("State")}),c.resolve(a.projects)}})}}),c.promise},readStories:function(b){var c=this,d=_.map(b,function(b){var d=Ext.create("Deft.Deferred");return a._loadAStoreWithAPromise("HierarchicalRequirement",["ObjectID","ScheduleState","PlanEstimate","Project"],[a.filter],{project:b.get("_ref"),projectScopeUp:!1,projectScopeDown:!0}).then({scope:c,success:function(a){d.resolve(a)}}),d.promise});return Deft.Promise.all(d)},readFeatures:function(b){var c=this,d=function(){var b=Ext.create("Deft.Deferred");return a._loadAStoreWithAPromise("TypeDefinition",["TypePath"],[{property:"Ordinal",operator:"=",value:0}]).then({scope:c,success:function(a){b.resolve(_.first(a).get("TypePath"))}}),b.promise},e=function(d){var e=_.map(b,function(b){var e=Ext.create("Deft.Deferred");return a._loadAStoreWithAPromise(d,["FormattedID","Name","ObjectID","LeafStoryCount","LeafStoryPlanEstimateTotal","PreliminaryEstimate","AcceptedLeafStoryCount","AcceptedLeafStoryPlanEstimateTotal","PercentDoneByStoryCount","c_ValueMetricKPI","Rank","State"],[a.featureFilter],{project:b.get("_ref"),projectScopeUp:!1,projectScopeDown:!0},[{property:"DragAndDropRank",direction:"ASC"}]).then({scope:c,success:function(a){e.resolve(a)}}),e.promise});return Deft.Promise.all(e)},f=Ext.create("Deft.Deferred");return Deft.Chain.pipeline([d,e],a).then({success:function(a){f.resolve(a)}}),f.promise},readPreferenceValues:function(b){var c=this,d=_.map(b,function(b){var d=Ext.create("Deft.Deferred");return a._loadAStoreWithAPromise("Preference",["Name","Value"],[{property:"Name",operator:"=",value:b}]).then({scope:c,success:function(a){d.resolve(a)},failure:function(a){d.resolve("")}}),d.promise});return Deft.Promise.all(d)},_loadAStoreWithAPromise:function(a,b,c,d,e){var f=Ext.create("Deft.Deferred"),g={model:a,fetch:b,filters:c,limit:"Infinity"};return _.isUndefined(d)||_.isNull(d)||(g.context=d),_.isUndefined(e)||_.isNull(e)||(g.order=e),Ext.create("Rally.data.wsapi.Store",g).load({callback:function(a,b,c){c?f.resolve(a):f.reject("Problem loading: "+b.error.errors.join(". "))}}),f.promise}}}),Ext.define("RallyFunctions",function(){var a;return{config:{ctx:{}},constructor:function(b){return a=this,this.initConfig(b),this},_wsapiQuery:function(a,b){var c={autoLoad:!0,limit:"Infinity",model:a.model,fetch:a.fetch,filters:a.filters,listeners:{scope:this,load:function(a,c){b(null,c)}}};_.isUndefined(a.context)||(c.context=a.context),Ext.create("Rally.data.WsapiDataStore",c)},createFilter:function(a,b,c){var d=null;if(!_.isNull(a)){var e=[{property:"Release.Name",value:a}];c&&e.push({property:c+".Release.Name",value:a}),d=Rally.data.wsapi.Filter.or(e)}if(!_.isNull(b)){var f=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",operator:"=",value:b});d=_.isNull(d)?f:d.and(f)}return d},createFeatureFilter:function(a){var b=null;return _.isNull(a)||(b=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operator:"=",value:a})),b},subscribe:function(a){a.subscribe(a,"timeboxReleaseChanged",a._timeboxChanged,a),a.subscribe(a,"timeboxIterationChanged",a._timeboxChanged,a)}}}),Ext.define("timebox-selector",{extend:"Ext.Container",componentCls:"app",alias:"widget.timebox-selector",cls:"timebox-selector",layout:"hbox",mixins:["Rally.Messageable"],constructor:function(){this.stateId=Rally.environment.getContext().getScopedStateId("timebox-filter"),this.callParent(arguments)},initComponent:function(){this.callParent(arguments),this._createReleaseCombo(),this.addEvents("releasechange","iterationchange"),this.subscribe(this,"requestTimebox",this._requestTimebox,this)},_createReleaseCombo:function(){this._releaseCombo=this.add({xtype:"rallyreleasecombobox",fieldLabel:"Program Increment",hideLabel:!1,labelPad:5,labelSeparator:":",labelWidth:130,width:280,labelAlign:"right",stateful:!1,stateId:"releasecombo",padding:5,context:Rally.environment.getContext(),showArrows:!1,growToLongestValue:!0,defaultToCurrentTimebox:!0,listeners:{change:function(a,b,c,d){var e=a.getRecord();this.fireEvent("releasechange",e),this.publish("timeboxReleaseChanged",e),this._updateIterationCombo(e)},scope:this}})},_updateIterationCombo:function(a){this.remove("globaliterationpicker"),this.fireEvent("iterationchange",null),this.publish("timeboxIterationChanged",null);var b=Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<=",value:Rally.util.DateTime.toIsoString(a.get("ReleaseDate"))}),c=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:">=",value:Rally.util.DateTime.toIsoString(a.get("ReleaseStartDate"))}),d=b.and(c);this._iterationCombo=this.add({xtype:"rallyiterationcombobox",itemId:"globaliterationpicker",fieldLabel:"Sprint/Iteration",hideLabel:!1,labelPad:5,labelSeparator:":",labelWidth:100,labelAlign:"right",stateful:!1,padding:5,context:Rally.environment.getContext(),showArrows:!1,growToLongestValue:!0,stateId:"iterationcombo",allowBlank:!0,allowClear:!1,allowNoEntry:!0,noEntryText:"PI Scope",emptyText:"PI Scope",noEntryValue:null,defaultToCurrentTimebox:!1,defaultSelectPosition:"first",storeConfig:{remoteFilter:!0,filters:d},listeners:{change:function(a,b,c,d){var e=a.getRecord();this.fireEvent("iterationchange",e),this.publish("timeboxIterationChanged",e)},scope:this}})},_requestTimebox:function(a){var b=this.getReleaseRecord();b&&this.publish("timeboxReleaseChanged",b);var c=this.getIterationRecord();c&&this.publish("timeboxIterationChanged",c)},getReleaseRecord:function(){return this._releaseCombo?this._releaseCombo.getRecord()||null:null},getIterationRecord:function(){return this._iterationCombo?this._iterationCombo.getRecord()||null:null}});
            
               Rally.launchApp('TSProgressByProject', {
                   name: 'Progress by Project'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}


    </style>

</head>
<body></body>
</html>